<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ä¿®æ”¹æ¨™é¡Œï¼šä½¿ç”¨é›»è…¦ Emoji -->
    <title>ä¸€æ–°ä¸­å­¸ç†è²¡ ğŸ’»</title>
    
    <!-- â˜…â˜…â˜… è¨­å®šè‡ªè¨‚ Icon â˜…â˜…â˜… -->
    <link rel="icon" type="image/png" href="icon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Noto Sans TC', 'Segoe UI', sans-serif; 
            background-color: #FFFBEB; /* æš–é»ƒè‰²èƒŒæ™¯ */
            background-image: radial-gradient(#FEF3C7 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .transition-all { transition: all 0.3s ease; }
        
        /* æ›´æœ‰è¶£çš„å¡ç‰‡æ‡¸æµ®æ•ˆæœ */
        .card-hover { transition: transform 0.2s, box-shadow 0.2s; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }

        /* æ»‘æ¡¿æ¨£å¼å„ªåŒ– - å¢åŠ é»æ“Šå€åŸŸ */
        input[type=range] { 
            -webkit-appearance: none; background: transparent; cursor: pointer; position: relative; z-index: 20; height: 30px; margin: 10px 0;
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%; background: #ffffff; border: 4px solid currentColor; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; height: 8px; cursor: pointer; background: #e5e7eb; border-radius: 999px; 
        }
        
        /* å®šç¾©æ»‘æ¡¿é¡è‰² */
        .accent-10B981 { color: #10B981; }
        .accent-3B82F6 { color: #3B82F6; }
        .accent-F59E0B { color: #F59E0B; }
        .accent-EF4444 { color: #EF4444; }
        .accent-8B5CF6 { color: #8B5CF6; }
        .accent-475569 { color: #475569; }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" v-cloak class="min-h-screen flex flex-col">
        
        <!-- å°èˆªåˆ— (åŠ å…¥å¿«é€Ÿåˆ‡æ›æŒ‰éˆ•) -->
        <nav class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-slate-100">
            <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-2">
                <div class="flex items-center space-x-2 font-bold text-xl text-emerald-600 tracking-wide cursor-pointer" @click="view = 'welcome'">
                    <i class="fa-solid fa-leaf text-emerald-500"></i>
                    <span>ä¸€æ–°ä¸­å­¸ç†è²¡ <span class="text-slate-400 text-sm font-normal ml-1 hidden sm:inline">| ğŸ’» å–®æ©Ÿç‰ˆ</span></span>
                </div>
                
                <!-- å¿«é€Ÿåˆ‡æ›è¦–è§’æŒ‰éˆ• -->
                <div class="flex space-x-2 text-sm font-medium" v-if="view !== 'welcome'">
                    <button @click="view = 'student'" 
                        :class="view === 'student' ? 'bg-amber-100 text-amber-700' : 'text-slate-500 hover:bg-slate-100'"
                        class="px-3 py-1.5 rounded-lg transition flex items-center">
                        <i class="fa-solid fa-user mr-1"></i> æˆ‘çš„è³‡ç”¢
                    </button>
                    <button @click="view = 'teacher'" 
                        :class="view === 'teacher' ? 'bg-emerald-100 text-emerald-700' : 'text-slate-500 hover:bg-slate-100'"
                        class="px-3 py-1.5 rounded-lg transition flex items-center">
                        <i class="fa-solid fa-chart-line mr-1"></i> å¸‚å ´æ¨¡æ“¬ (è€å¸«)
                    </button>
                    <div class="w-px h-6 bg-slate-200 mx-1"></div>
                    <button @click="view = 'welcome'" class="px-3 py-1.5 rounded-lg text-slate-500 hover:bg-slate-100 transition">
                        <i class="fa-solid fa-house"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <main class="container mx-auto p-4 md:p-8 flex-grow">
            
            <!-- 1. æ­¡è¿ç•«é¢ -->
            <div v-if="view === 'welcome'" class="flex flex-col items-center justify-center h-[80vh] space-y-8 animate-fade-in">
                <div class="text-center space-y-4">
                    <span class="inline-block px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold tracking-wider">FINANCIAL LITERACY WORKSHOP</span>
                    <h1 class="text-4xl md:text-6xl font-bold text-slate-800 tracking-tight">æˆ‘æ˜¯å¤§å¯Œç¿ <span class="text-emerald-500">Offline ğŸ’»</span></h1>
                    <p class="text-slate-500">å–®æ©Ÿç·´ç¿’æ¨¡å¼ï¼šå¯è‡ªç”±åˆ‡æ›ã€Œå€‹äººç·´ç¿’ã€èˆ‡ã€Œå¸‚å ´æ¨¡æ“¬ã€è¦–è§’ã€‚</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-3xl mt-8">
                    <button @click="view = 'student'" class="group relative p-8 bg-white rounded-3xl shadow-lg card-hover border-2 border-transparent hover:border-amber-200 text-left overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-amber-50 rounded-bl-full -mr-8 -mt-8 z-0 group-hover:scale-110 transition"></div>
                        <div class="relative z-10">
                            <div class="w-12 h-12 bg-amber-100 rounded-2xl flex items-center justify-center text-amber-600 mb-4 text-2xl">
                                <i class="fa-solid fa-mobile-screen"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-1 text-slate-800">é€²å…¥å€‹äººç·´ç¿’</h3>
                            <p class="text-slate-400 text-sm">Student Mode</p>
                            <p class="text-slate-500 mt-4 text-sm">æ“ä½œä½ è‡ªå·±çš„é ç®—èˆ‡æŠ•è³‡ï¼Œè¨ˆç®—æœ€çµ‚è³‡ç”¢ã€‚</p>
                        </div>
                    </button>

                    <button @click="view = 'teacher'" class="group relative p-8 bg-white rounded-3xl shadow-lg card-hover border-2 border-transparent hover:border-emerald-200 text-left overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-50 rounded-bl-full -mr-8 -mt-8 z-0 group-hover:scale-110 transition"></div>
                        <div class="relative z-10">
                            <div class="w-12 h-12 bg-emerald-100 rounded-2xl flex items-center justify-center text-emerald-600 mb-4 text-2xl">
                                <i class="fa-solid fa-chart-simple"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-1 text-slate-800">æŸ¥çœ‹å¸‚å ´æ¨¡æ“¬</h3>
                            <p class="text-slate-400 text-sm">Simulation / Teacher View</p>
                            <p class="text-slate-500 mt-4 text-sm">è§€çœ‹ 13 çµ„æ¨¡æ“¬æ•¸æ“šçš„å¸‚å ´è®ŠåŒ–èˆ‡é•·æœŸè¤‡åˆ©åœ–è¡¨ã€‚</p>
                        </div>
                    </button>
                </div>
                
                <div class="mt-12">
                    <button @click="hardReset" class="text-xs text-slate-400 hover:text-red-500 border-b border-transparent hover:border-red-500 transition">
                        <i class="fa-solid fa-rotate-right mr-1"></i> æ¸…é™¤æœ¬æ©Ÿæš«å­˜è³‡æ–™
                    </button>
                </div>
            </div>

            <!-- 2. è€å¸«æ¼”ç¤ºæ¨¡å¼ (æ¨¡æ“¬æ•¸æ“š) -->
            <div v-if="view === 'teacher'" class="space-y-6">
                <!-- é ‚éƒ¨æ§åˆ¶åˆ— -->
                <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-emerald-500 flex flex-wrap gap-4 justify-between items-center sticky top-20 z-40">
                    <div class="flex items-center space-x-3">
                        <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600"><i class="fa-solid fa-chart-pie"></i></div>
                        <div>
                            <h2 class="text-lg font-bold text-slate-800">å¸‚å ´æ¨¡æ“¬çœ‹æ¿ (è€å¸«è¦–è§’)</h2>
                            <p class="text-xs text-slate-400">æ­¤è™•é¡¯ç¤ºçš„æ˜¯ç³»çµ±ç”Ÿæˆçš„ 13 çµ„æ¨¡æ“¬æ•¸æ“š</p>
                        </div>
                    </div>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button v-for="s in [1, 2, 3]" :key="s" @click="setStage(s)" 
                            :class="stage === s ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'"
                            class="px-4 py-2 rounded-lg text-sm font-bold transition">
                            {{ ['1. é ç®—', '2. æŠ•è³‡', '3. ç¸½çµ'][s-1] }}
                        </button>
                    </div>
                </div>

                <!-- è€å¸«æ§åˆ¶å€ -->
                <div class="flex flex-wrap gap-3">
                    <button v-if="stage === 1" @click="inflationTriggered = !inflationTriggered" 
                        :class="inflationTriggered ? 'bg-rose-500 text-white ring-4 ring-rose-200' : 'bg-white text-rose-500 border-2 border-rose-100 hover:border-rose-500'"
                        class="px-6 py-3 rounded-xl font-bold shadow-sm transition flex items-center">
                        <i class="fa-solid fa-triangle-exclamation mr-2"></i> 
                        {{ inflationTriggered ? 'æ¼”ç¤ºï¼šé€šè†¨å·²è§¸ç™¼' : 'æ¼”ç¤ºï¼šè§¸ç™¼é€šè†¨' }}
                    </button>

                    <button v-if="stage === 2" @click="drawFateCard" 
                        class="px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 transition flex items-center bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-105 active:scale-95">
                        <i class="fa-solid fa-dice mr-2"></i> æŠ½å–å‘½é‹å¡ (æ¨¡æ“¬å¸‚å ´)
                    </button>
                </div>

                <!-- è€å¸«åœ–è¡¨å€ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div v-if="stage === 2" class="md:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-bold text-xl text-slate-800"><i class="fa-solid fa-chart-simple mr-2 text-blue-500"></i> è³‡ç”¢æ¨¡æ“¬æ’è¡Œ</h3>
                            <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded">ç¯„ä¾‹æ•¸æ“š</span>
                        </div>
                        <div v-if="lastDrawnCard" class="mb-6 p-4 bg-indigo-50 border border-indigo-100 text-indigo-700 rounded-xl text-center animate-bounce">
                            <span class="block text-xs font-bold uppercase tracking-wider opacity-70 mb-1">Market Event</span>
                            <strong class="text-lg">{{ lastDrawnCard }}</strong>
                        </div>
                        <div class="h-64 relative"><canvas id="teacherAssetChart"></canvas></div>
                    </div>

                    <div v-if="stage === 3" class="md:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-xl text-slate-800 mb-6 text-center">20 å¹´è³‡ç”¢æ¨¡æ“¬ <span class="text-sm font-normal text-slate-400">(å‰ä¸‰å vs å¾Œä¸‰å)</span></h3>
                        <div class="h-80 relative"><canvas id="teacherLineChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 3. å­¸ç”Ÿæ“ä½œä»‹é¢ (æœ¬åœ°è¨ˆç®—) -->
            <div v-if="view === 'student'" class="max-w-md mx-auto pb-24 space-y-6">
                
                <div class="sticky top-4 z-30 bg-white/95 backdrop-blur p-4 rounded-2xl shadow-lg border border-slate-100 flex justify-between items-center">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center text-amber-600 mr-3 font-bold">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400">Current Group</div>
                            <select v-model="myGroupName" class="bg-transparent font-bold text-slate-800 outline-none cursor-pointer">
                                <option v-for="i in 13" :key="i" :value="`ç¬¬ ${i} çµ„`">ç¬¬ {{ i }} çµ„</option>
                            </select>
                        </div>
                    </div>
                    <!-- å­¸ç”Ÿæ‰‹å‹•åˆ‡æ›éšæ®µ -->
                    <select v-model.number="stage" class="text-xs bg-slate-800 text-white rounded-lg px-2 py-1 border-none cursor-pointer">
                        <option :value="1">Step 1: é ç®—</option>
                        <option :value="2">Step 2: æŠ•è³‡</option>
                        <option :value="3">Step 3: ç¸½çµ</option>
                    </select>
                </div>

                <!-- Stage 1: é ç®— -->
                <div v-if="stage === 1" class="bg-white rounded-3xl shadow-sm p-6 space-y-6 border border-slate-100">
                    <button @click="inflationTriggered = !inflationTriggered" 
                        class="w-full py-3 rounded-xl text-sm font-bold transition border-2 border-dashed flex items-center justify-center"
                        :class="inflationTriggered ? 'bg-rose-50 text-rose-600 border-rose-200' : 'bg-slate-50 text-slate-400 border-slate-200 hover:bg-slate-100'">
                        <i class="fa-solid fa-triangle-exclamation mr-2"></i> 
                        {{ inflationTriggered ? 'é€šè†¨æ¨¡å¼ï¼šå·²é–‹å•Ÿ (+10%)' : 'é»æ­¤é–‹å•Ÿé€šè†¨ (è·Ÿéš¨è€å¸«)' }}
                    </button>

                    <div class="flex justify-between items-end border-b border-slate-100 pb-4">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">é ç®—è¦åŠƒ</h2>
                            <p class="text-xs text-slate-400">Monthly Budget</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-500">çµé¤˜</div>
                            <div class="text-xl font-mono font-bold" :class="myBalance < 0 ? 'text-rose-500' : 'text-emerald-500'">
                                {{ formatMoney(myBalance) }}
                            </div>
                        </div>
                    </div>

                    <!-- åœ“é¤…åœ– -->
                    <div class="h-48 relative flex justify-center">
                        <canvas id="studentPieChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none mt-4">
                             <span class="font-bold text-sm" :class="myBalance < 0 ? 'text-rose-500' : 'text-slate-400'">{{ myBalance < 0 ? 'é€æ”¯' : 'å‰©é¤˜' }}</span>
                             <span class="font-mono font-bold text-lg text-slate-600">{{ formatMoney(Math.abs(myBalance)) }}</span>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div v-for="(val, key) in myBudget" :key="key">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="font-bold text-slate-600 flex items-center">
                                    <span class="w-6 h-6 rounded-full flex items-center justify-center mr-2 text-white text-xs" :class="`bg-${{food:'emerald-500', transport:'blue-500', entertainment:'amber-500', education:'purple-500', family:'rose-500'}[key]}`">
                                        <i :class="getIcon(key)"></i>
                                    </span>
                                    {{ translate(key) }}
                                </span>
                                <span class="font-mono text-slate-500">{{ formatMoney(calculateExpenseItem(val)) }}</span>
                            </div>
                            <input type="range" min="0" max="10000" step="500" v-model.number="myBudget[key]" @input="updateStudentChart" class="w-full h-2 rounded-lg" :class="getColorClass(key)">
                        </div>
                    </div>
                </div>

                <!-- Stage 2: æŠ•è³‡ -->
                <div v-if="stage === 2" class="bg-white rounded-3xl shadow-sm p-6 space-y-6 border border-slate-100">
                    <div class="flex justify-between items-end border-b border-slate-100 pb-4">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">æŠ•è³‡é…ç½®</h2>
                            <p class="text-xs text-slate-400">Investment</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-500">å‰©é¤˜è³‡é‡‘ (éœ€ç‚º 0)</div>
                            <div class="text-xl font-mono font-bold" :class="investmentRemaining !== 0 ? 'text-rose-500' : 'text-slate-700'">
                                {{ formatMoney(investmentRemaining) }}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button @click="myRiskProfile = 'conservative'" :class="myRiskProfile === 'conservative' ? 'ring-2 ring-emerald-500 bg-emerald-50 text-emerald-700' : 'bg-slate-50 text-slate-400'" class="p-3 rounded-xl border transition text-sm font-bold">
                            <i class="fa-solid fa-shield-halved mr-1"></i> ç©©å¥å‹
                        </button>
                        <button @click="myRiskProfile = 'aggressive'" :class="myRiskProfile === 'aggressive' ? 'ring-2 ring-rose-500 bg-rose-50 text-rose-700' : 'bg-slate-50 text-slate-400'" class="p-3 rounded-xl border transition text-sm font-bold">
                            <i class="fa-solid fa-rocket mr-1"></i> ç©æ¥µå‹
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div v-for="(val, key) in myInvestment" :key="key">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="font-medium text-slate-700">{{ translate(key) }}</span>
                                <span class="font-mono text-slate-500">{{ formatMoney(val) }}</span>
                            </div>
                            <input type="range" min="0" max="100000" step="5000" v-model.number="myInvestment[key]" class="w-full h-2 rounded-lg accent-slate-600">
                        </div>
                    </div>
                    
                    <!-- æ‰‹å‹•äº‹ä»¶è§¸ç™¼ -->
                    <div class="pt-6 border-t border-slate-100">
                        <h3 class="font-bold text-slate-700 mb-3 flex items-center">
                            <i class="fa-solid fa-envelope-open-text mr-2 text-indigo-500"></i> å‘½é‹å¡ (è·Ÿéš¨è€å¸«é¸æ“‡)
                        </h3>
                        <select v-model="selectedFateCardIndex" class="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 mb-3 text-slate-700 font-medium">
                            <option :value="-1">-- è«‹é¸æ“‡è€å¸«æŠ½åˆ°çš„å¡ --</option>
                            <option v-for="(card, idx) in FATE_CARDS" :key="idx" :value="idx">{{ card.title }}</option>
                        </select>
                        <button @click="applyStudentFateCard" :disabled="selectedFateCardIndex === -1" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold disabled:bg-slate-200 disabled:text-slate-400 transition">
                            å¥—ç”¨æ•ˆæœ
                        </button>
                        
                        <div v-if="myTotalAssets !== INITIAL_CAPITAL" class="mt-6 p-4 bg-indigo-50 border border-indigo-100 rounded-2xl text-center">
                            <p class="text-xs text-indigo-400 uppercase font-bold tracking-wider mb-1">Current Assets</p>
                            <p class="text-3xl font-mono font-bold text-indigo-600">{{ formatMoney(Math.round(myTotalAssets)) }}</p>
                        </div>
                    </div>
                </div>

                <!-- Stage 3: çµæŸ -->
                <div v-if="stage === 3" class="bg-white rounded-3xl shadow-lg p-10 text-center">
                    <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fa-solid fa-trophy text-4xl text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2 text-slate-800">èª²ç¨‹çµæŸï¼</h2>
                    <p class="text-slate-500 text-sm mb-6">Congratulations!</p>
                    <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100">
                        <p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-2">Final Result</p>
                        <p class="text-4xl font-mono font-bold text-slate-800">{{ formatMoney(Math.round(myTotalAssets)) }}</p>
                    </div>
                    <p class="text-slate-400 text-xs mt-6">è«‹èˆ‰æ‰‹å›å ±æ­¤æ•¸å­—çµ¦è€å¸«é€²è¡Œçµç®—ã€‚</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;

        const INCOME = 20000;
        const INITIAL_CAPITAL = 100000;
        
        const FATE_CARDS = [
            { title: "è‚¡å¸‚å¤§æ¼²", effect: { stocks: 1.25, etf: 1.10, savings: 1.005, entrepreneurship: 1.05 } },
            { title: "é‡‘èæµ·å˜¯", effect: { stocks: 0.70, etf: 0.90, savings: 1.00, entrepreneurship: 0.80 } },
            { title: "ETF ç©©å¥æˆé•·", effect: { stocks: 1.05, etf: 1.15, savings: 1.005, entrepreneurship: 1.0 } },
            { title: "å…¨çƒé€šè†¨å‡æº«", effect: { stocks: 0.95, etf: 0.98, savings: 1.00, entrepreneurship: 0.90 } },
            { title: "å‰µæ¥­ç¨è§’ç¸", effect: { stocks: 1.0, etf: 1.05, savings: 1.005, entrepreneurship: 2.5 } },
            { title: "ç§‘æŠ€æ³¡æ²«", effect: { stocks: 0.85, etf: 0.95, savings: 1.00, entrepreneurship: 0.5 } },
        ];

        createApp({
            setup() {
                const view = ref('welcome');
                const stage = ref(1);
                const inflationTriggered = ref(false);
                const drawnCardIndices = ref([]); // è¨˜éŒ„å·²æŠ½éçš„å¡ç‰Œç´¢å¼•
                
                // Student State
                const myGroupName = ref('ç¬¬ 1 çµ„');
                const myBudget = ref({ food: 6000, transport: 3000, entertainment: 2000, education: 4000, family: 5000 });
                const myInvestment = ref({ savings: 25000, etf: 25000, stocks: 25000, entrepreneurship: 25000 });
                const myRiskProfile = ref('conservative');
                const myTotalAssets = ref(INITIAL_CAPITAL);
                const selectedFateCardIndex = ref(-1);

                // Teacher Simulated Data
                const simulatedGroups = ref([]);
                const lastDrawnCard = ref(null);

                // Init Simulation Data for Teacher
                const initSimData = () => {
                    simulatedGroups.value = Array.from({ length: 13 }, (_, i) => ({
                        id: i + 1,
                        name: `ç¬¬ ${i + 1} çµ„`,
                        investment: { savings: 25000, etf: 25000, stocks: 25000, entrepreneurship: 25000 },
                        totalAssets: 100000,
                        riskProfile: Math.random() > 0.5 ? 'aggressive' : 'conservative'
                    }));
                };
                initSimData();

                // Clean Reset
                const hardReset = () => {
                    if(confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰è¨­å®šä¸¦é‡ç½®ï¼Ÿ")) {
                        localStorage.clear();
                        location.reload();
                    }
                };

                // Computed
                const calculateExpenseItem = (val) => inflationTriggered.value ? val * 1.1 : val;
                const calculateTotalExpense = () => Object.values(myBudget.value).reduce((a, b) => a + b, 0) * (inflationTriggered.value ? 1.1 : 1);
                const myBalance = computed(() => INCOME - calculateTotalExpense());
                const investmentRemaining = computed(() => INITIAL_CAPITAL - Object.values(myInvestment.value).reduce((a, b) => a + b, 0));
                const isCardDeckEmpty = computed(() => drawnCardIndices.value.length >= FATE_CARDS.length);

                // Helpers
                const formatMoney = (val) => new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 }).format(val) + ' THB';
                const translate = (key) => ({ food: 'é£Ÿç‰©', transport: 'äº¤é€š', entertainment: 'å¨›æ¨‚', education: 'å­¸ç¿’', family: 'å®¶åº­', savings: 'å®šå­˜', etf: 'ETF', stocks: 'è‚¡ç¥¨', entrepreneurship: 'å‰µæ¥­' }[key] || key);
                const getIcon = (key) => `fa-solid ${{ food: 'fa-bowl-food', transport: 'fa-bus', entertainment: 'fa-gamepad', education: 'fa-book', family: 'fa-house' }[key] || 'fa-coins'}`;
                const getColorClass = (key) => `accent-${{food:'10B981', transport:'3B82F6', entertainment:'F59E0B', education:'8B5CF6', family:'EF4444'}[key]}`;

                // Student Logic
                const applyStudentFateCard = () => {
                    if(selectedFateCardIndex.value === -1) return;
                    const card = FATE_CARDS[selectedFateCardIndex.value];
                    
                    // Simple calculation for student
                    const inv = myInvestment.value;
                    const newInv = {
                        savings: inv.savings * card.effect.savings,
                        etf: inv.etf * card.effect.etf,
                        stocks: inv.stocks * card.effect.stocks,
                        entrepreneurship: inv.entrepreneurship * card.effect.entrepreneurship
                    };
                    myInvestment.value = newInv; // Update local state
                    myTotalAssets.value = Object.values(newInv).reduce((a, b) => a + b, 0);
                    
                    alert(`å·²å¥—ç”¨ï¼š${card.title}\nè³‡ç”¢æ›´æ–°ï¼`);
                    selectedFateCardIndex.value = -1;
                };

                // Teacher Logic (Simulated)
                const setStage = (s) => {
                    stage.value = s;
                    nextTick(() => setTimeout(updateCharts, 300));
                };

                // å–®æ©Ÿç‰ˆä¹Ÿè¦é¿å…é‡è¤‡æŠ½å¡
                const drawFateCard = () => {
                    const availableIndices = FATE_CARDS.map((_, i) => i).filter(i => !drawnCardIndices.value.includes(i));
                    
                    if (availableIndices.length === 0) {
                         alert('å¡ç‰Œå·²ç”¨ç›¡');
                         return;
                    }

                    const randomIndex = Math.floor(Math.random() * availableIndices.length);
                    const cardIndex = availableIndices[randomIndex];
                    const card = FATE_CARDS[cardIndex];
                    
                    // è¨˜éŒ„å·²æŠ½éçš„
                    drawnCardIndices.value.push(cardIndex);
                    lastDrawnCard.value = card.title;
                    
                    // Update simulated groups
                    simulatedGroups.value.forEach(g => {
                        const inv = g.investment;
                        g.investment = {
                            savings: inv.savings * card.effect.savings,
                            etf: inv.etf * card.effect.etf,
                            stocks: inv.stocks * card.effect.stocks,
                            entrepreneurship: inv.entrepreneurship * card.effect.entrepreneurship
                        };
                        g.totalAssets = Object.values(g.investment).reduce((a,b) => a+b, 0);
                    });
                    nextTick(updateCharts);
                };

                // Charts
                let studentChartInstance = null;
                const updateStudentChart = () => {
                    const ctx = document.getElementById('studentPieChart');
                    if (!ctx) return;
                    
                    const dataValues = Object.values(myBudget.value);
                    const bgColors = ['#10B981', '#3B82F6', '#F59E0B', '#8B5CF6', '#EF4444'];

                    if (studentChartInstance) {
                        studentChartInstance.data.datasets[0].data = dataValues;
                        studentChartInstance.update();
                    } else {
                        studentChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: { labels: Object.keys(myBudget.value).map(translate), datasets: [{ data: dataValues, backgroundColor: bgColors, borderWidth: 0 }] },
                            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
                        });
                    }
                };

                let teacherAssetChartInstance = null;
                let teacherLineChartInstance = null;
                const updateCharts = () => {
                    if (view.value !== 'teacher') return;

                    if (stage.value === 2) {
                        const ctx = document.getElementById('teacherAssetChart');
                        if (ctx) {
                            if (teacherAssetChartInstance) teacherAssetChartInstance.destroy();
                            teacherAssetChartInstance = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: simulatedGroups.value.map(g => g.name),
                                    datasets: [{ label: 'ç¸½è³‡ç”¢', data: simulatedGroups.value.map(g => g.totalAssets), backgroundColor: '#3B82F6' }]
                                },
                                options: { responsive: true, maintainAspectRatio: false }
                            });
                        }
                    }
                    
                    if (stage.value === 3) {
                        const ctx = document.getElementById('teacherLineChart');
                        if (ctx) {
                            if (teacherLineChartInstance) teacherLineChartInstance.destroy();
                            // Generate simulation data... (Same logic as online version but fully local)
                             const sorted = [...simulatedGroups.value].sort((a, b) => b.totalAssets - a.totalAssets);
                             const targets = sorted.slice(0, 3).concat(sorted.slice(-3));
                             const years = Array.from({length: 21}, (_, i) => `${i}å¹´`);
                             const datasets = targets.map(g => {
                                const total = g.totalAssets;
                                const inv = g.investment;
                                // Weighted return
                                const weightedReturn = (
                                    (inv.savings * 0.02) + 
                                    (inv.etf * 0.06) + 
                                    (inv.stocks * 0.08) + 
                                    (inv.entrepreneurship * 0.12)
                                ) / total;
                                
                                const baseRate = 1 + weightedReturn;
                                
                                // Risk logic (Same as Online)
                                const entrepreneurialRatio = inv.entrepreneurship / total;
                                let hasFailed = false;
                                const seed = (g.id * 11) % 100; 
                                if (entrepreneurialRatio > 0.3 && seed < 30) {
                                    hasFailed = true;
                                }
                                
                                let data = [Math.round(total)];
                                let currentAsset = total;
                                
                                for(let y=1; y<=20; y++) {
                                    if (hasFailed && y >= 10) {
                                        currentAsset = (inv.savings + inv.etf + inv.stocks) * Math.pow(0.98, y - 10);
                                        currentAsset = Math.max(currentAsset, total * 0.1);
                                    } else {
                                        currentAsset = g.totalAssets * Math.pow(baseRate, y);
                                    }
                                    data.push(Math.round(currentAsset));
                                }
                                
                                // Color
                                const isTop = top3Ids.includes(g.id);
                                const rank = sorted.findIndex(s => s.id === g.id) + 1;
                                
                                let distinctColor;
                                if (isTop) {
                                    if(rank === 1) distinctColor = '#059669'; 
                                    else if(rank === 2) distinctColor = '#10B981';
                                    else distinctColor = '#6EE7B7';
                                } else {
                                    const bottomIndex = bottom3Ids.indexOf(g.id); 
                                    if(bottomIndex === 2) distinctColor = '#7F1D1D';
                                    else if(bottomIndex === 1) distinctColor = '#DC2626';
                                    else distinctColor = '#FCA5A5';
                                }
                                
                                const labelSuffix = hasFailed ? " (é¢¨éšªçˆ†ç™¼)" : ` (å¹´åŒ– ${(weightedReturn * 100).toFixed(1)}%)`;

                                return {
                                    label: `No.${rank} ${g.name}` + labelSuffix,
                                    data: data,
                                    borderColor: distinctColor,
                                    backgroundColor: distinctColor,
                                    borderWidth: isTop ? 3 : 2,
                                    borderDash: hasFailed ? [10, 5] : [],
                                    fill: false,
                                    tension: 0.4
                                };
                             });

                            teacherLineChartInstance = new Chart(ctx, {
                                type: 'line',
                                data: { labels: years, datasets: datasets },
                                options: { responsive: true, maintainAspectRatio: false }
                            });
                        }
                    }
                };

                watch(view, (newVal) => {
                    if(newVal === 'student' && stage.value === 1) nextTick(updateStudentChart);
                    if(newVal === 'teacher') nextTick(() => setTimeout(updateCharts, 300));
                });
                watch(myBudget, updateStudentChart, { deep: true });
                watch(stage, () => {
                    if(view.value === 'student' && stage.value === 1) nextTick(updateStudentChart);
                    if(view.value === 'teacher') nextTick(() => setTimeout(updateCharts, 300));
                });

                return {
                    view, stage, inflationTriggered,
                    myGroupName, myBudget, myInvestment, myRiskProfile, myTotalAssets, selectedFateCardIndex,
                    simulatedGroups, lastDrawnCard, drawnCardIndices, isCardDeckEmpty,
                    hardReset, formatMoney, translate, getIcon, getColorClass,
                    calculateExpenseItem, calculateTotalExpense, myBalance, investmentRemaining,
                    applyStudentFateCard, updateStudentChart,
                    setStage, drawFateCard,
                    INITIAL_CAPITAL, INCOME, FATE_CARDS
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
