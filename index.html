<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘æ˜¯å¤§å¯Œç¿ (å–®æ©Ÿç‰ˆ)</title>
    
    <!-- Icon -->
    <link rel="icon" type="image/png" href="icon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: åªä¿ç•™ Fredoka ç”¨æ–¼è£é£¾æ•¸å­—å’Œè‹±æ–‡ï¼Œä¸­æ–‡ä½¿ç”¨ç³»çµ±å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // ä¸­æ–‡ä½¿ç”¨ç³»çµ±é è¨­ (å¾®è»Ÿæ­£é»‘é«”ç­‰)ï¼Œç¢ºä¿æ¸…æ™°ç†Ÿæ‚‰
                        sans: ['"Segoe UI"', '"Microsoft JhengHei"', 'sans-serif'],
                        // æ¨™é¡Œè‹±æ–‡æ•¸å­—ä¿ç•™å¯æ„›é¢¨æ ¼
                        display: ['"Fredoka"', 'cursive'],
                    },
                    colors: {
                        retro: {
                            bg: '#FFF8E7',      
                            pink: '#FF8FAB',    
                            green: '#06D6A0',   
                            yellow: '#FFD166',  
                            blue: '#118AB2',    
                            red: '#EF476F',     
                            dark: '#073B4C',    
                        }
                    },
                    boxShadow: {
                        'retro': '4px 4px 0px 0px rgba(7, 59, 76, 1)', 
                        'retro-sm': '2px 2px 0px 0px rgba(7, 59, 76, 1)',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            /* ç¢ºä¿å…¨åŸŸå­—é«”è¨­å®šæ­£ç¢º */
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: #FFF8E7;
            background-image: radial-gradient(#FFD166 2px, transparent 2px);
            background-size: 30px 30px;
        }
        
        .btn-retro {
            border: 2px solid #073B4C;
            box-shadow: 4px 4px 0px 0px #073B4C;
            transition: all 0.1s;
        }
        .btn-retro:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px 0px #073B4C;
        }

        .card-retro {
            background: white;
            border: 2px solid #073B4C;
            border-radius: 1rem;
            box-shadow: 6px 6px 0px 0px rgba(0,0,0,0.1);
        }

        input[type=range] { 
            -webkit-appearance: none; background: transparent; cursor: pointer; position: relative; z-index: 20; height: 30px; margin: 10px 0; width: 100%;
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; 
            background: #FFD166; border: 2px solid #073B4C; 
            cursor: pointer; margin-top: -10px; box-shadow: 2px 2px 0px #073B4C;
        }
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; height: 6px; cursor: pointer; background: #073B4C; border-radius: 4px; 
        }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="text-retro-dark font-sans">

    <div id="app" v-cloak class="min-h-screen flex flex-col">
        
        <nav class="bg-white border-b-2 border-retro-dark sticky top-0 z-50 px-4 py-3 shadow-sm">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-2">
                <div class="flex items-center gap-2 font-bold text-xl tracking-wide cursor-pointer" @click="view = 'welcome'">
                    <div class="bg-retro-yellow w-10 h-10 rounded-full border-2 border-retro-dark flex items-center justify-center text-xl shadow-retro-sm">ğŸ’°</div>
                    <!-- æ¨™é¡Œä½¿ç”¨ display å­—é«” (å¯æ„›é¢¨)ï¼Œå‰¯æ¨™é¡Œä½¿ç”¨ sans (ç³»çµ±å­—é«”) -->
                    <span class="font-display text-retro-dark">æˆ‘æ˜¯å¤§å¯Œç¿ <span class="text-gray-400 text-sm font-sans font-bold ml-1">| å–®æ©Ÿç‰ˆ</span></span>
                </div>
                
                <div class="flex gap-2 text-sm font-bold font-sans" v-if="view !== 'welcome'">
                    <button @click="view = 'student'" 
                        :class="view === 'student' ? 'bg-retro-yellow text-retro-dark shadow-retro-sm' : 'bg-white text-gray-400 hover:text-retro-dark'"
                        class="px-4 py-1.5 rounded-lg border-2 border-retro-dark transition">
                        å€‹äººç·´ç¿’
                    </button>
                    <button @click="view = 'teacher'" 
                        :class="view === 'teacher' ? 'bg-retro-green text-white shadow-retro-sm' : 'bg-white text-gray-400 hover:text-retro-dark'"
                        class="px-4 py-1.5 rounded-lg border-2 border-retro-dark transition">
                        å¸‚å ´æ¨¡æ“¬
                    </button>
                    <button @click="view = 'welcome'" class="px-3 py-1.5 rounded-lg text-gray-400 hover:text-retro-red transition">
                        <i class="fa-solid fa-house"></i>
                    </button>
                </div>
            </div>
        </nav>

        <main class="container mx-auto p-4 md:p-8 flex-grow flex flex-col items-center justify-center">
            
            <!-- 1. æ­¡è¿ç•«é¢ -->
            <div v-if="view === 'welcome'" class="flex flex-col items-center justify-center w-full max-w-4xl animate-fade-in">
                <div class="text-center mb-8">
                    <span class="bg-retro-dark text-white px-4 py-1 rounded-full text-sm font-bold tracking-widest uppercase mb-2 inline-block font-display">Financial Game</span>
                    <h1 class="font-display text-5xl md:text-7xl font-bold text-retro-dark drop-shadow-sm">æˆ‘æ˜¯å¤§å¯Œç¿ <span class="text-retro-green">Offline</span></h1>
                    <p class="text-gray-500 mt-4 font-bold font-sans">å–®æ©Ÿç·´ç¿’æ¨¡å¼ï¼šè‡ªç”±åˆ‡æ›è¦–è§’ï¼Œç„¡éœ€é€£ç·šã€‚</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full">
                    <button @click="view = 'student'" class="card-retro p-8 hover:bg-retro-yellow transition group text-left relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 text-9xl opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-mobile-screen"></i></div>
                        <h3 class="font-display text-3xl font-bold mb-2">å€‹äººç·´ç¿’</h3>
                        <p class="text-sm opacity-70 font-bold font-display">STUDENT MODE</p>
                        <p class="mt-4 text-sm font-sans">æ“ä½œé ç®—èˆ‡æŠ•è³‡ï¼Œè¨ˆç®—å€‹äººæœ€çµ‚è³‡ç”¢ã€‚</p>
                    </button>

                    <button @click="view = 'teacher'" class="card-retro p-8 hover:bg-retro-green hover:text-white transition group text-left relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 text-9xl opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-chart-simple"></i></div>
                        <h3 class="font-display text-3xl font-bold mb-2">å¸‚å ´æ¨¡æ“¬</h3>
                        <p class="text-sm opacity-70 font-bold font-display">SIMULATION VIEW</p>
                        <p class="mt-4 text-sm font-sans">è§€çœ‹ 13 çµ„æ¨¡æ“¬æ•¸æ“šèˆ‡é•·æœŸè¤‡åˆ©è®ŠåŒ–ã€‚</p>
                    </button>
                </div>
                
                <button @click="hardReset" class="mt-12 text-xs text-gray-400 hover:text-retro-red border-b-2 border-transparent hover:border-retro-red font-bold transition font-sans">
                    æ¸…é™¤æš«å­˜ (Reset)
                </button>
            </div>

            <!-- 2. è€å¸«æ¼”ç¤ºæ¨¡å¼ (æ¨¡æ“¬æ•¸æ“š) -->
            <div v-if="view === 'teacher'" class="w-full space-y-6 font-sans">
                <!-- é ‚éƒ¨æ§åˆ¶ -->
                <div class="card-retro p-4 bg-white flex flex-wrap gap-4 justify-between items-center sticky top-20 z-40">
                    <div class="flex items-center gap-3">
                        <div class="bg-retro-pink w-10 h-10 rounded-lg border-2 border-retro-dark flex items-center justify-center text-white font-bold text-xl shadow-retro-sm">T</div>
                        <div>
                            <h2 class="font-bold text-lg text-retro-dark">å¸‚å ´æ¨¡æ“¬</h2>
                            <p class="text-xs font-bold text-gray-400 uppercase">Simulated Data</p>
                        </div>
                    </div>
                    <div class="flex gap-2 bg-gray-100 p-1.5 rounded-lg border-2 border-gray-200">
                        <button v-for="s in [1, 2, 3]" :key="s" @click="setStage(s)" 
                            :class="stage === s ? 'bg-retro-blue text-white shadow-sm' : 'text-gray-400 hover:text-gray-600'"
                            class="px-4 py-1.5 rounded-md font-bold transition text-sm">
                            {{ ['1.é ç®—', '2.æŠ•è³‡', '3.ç¸½çµ'][s-1] }}
                        </button>
                    </div>
                </div>

                <!-- æ§åˆ¶å€ -->
                <div class="flex flex-wrap gap-3">
                    <button v-if="stage === 1" @click="inflationTriggered = !inflationTriggered" 
                        :class="inflationTriggered ? 'bg-retro-red text-white' : 'bg-white text-retro-red'"
                        class="btn-retro px-6 py-3 rounded-xl font-bold flex items-center">
                        <i class="fa-solid fa-fire mr-2"></i> 
                        {{ inflationTriggered ? 'æ¨¡æ“¬ï¼šé€šè†¨å·²è§¸ç™¼' : 'æ¨¡æ“¬ï¼šè§¸ç™¼é€šè†¨' }}
                    </button>

                    <button v-if="stage === 2" @click="drawFateCard" 
                        class="btn-retro bg-retro-pink text-white px-6 py-3 rounded-xl font-bold flex items-center">
                        <i class="fa-solid fa-star mr-2"></i> æŠ½å–å‘½é‹å¡
                    </button>
                </div>

                <!-- åœ–è¡¨å€ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div v-if="stage === 2" class="md:col-span-2 card-retro p-6 bg-white">
                        <h3 class="font-bold text-xl mb-4 border-b-2 border-gray-100 pb-2">è³‡ç”¢æ¨¡æ“¬æ’è¡Œ</h3>
                        <div v-if="lastDrawnCard" class="mb-4 p-3 bg-retro-yellow border-2 border-retro-dark rounded-lg shadow-retro-sm text-center">
                            <div class="text-xs font-bold opacity-60 uppercase">Event</div>
                            <div class="font-bold text-lg">{{ lastDrawnCard }}</div>
                        </div>
                        <div class="h-64 relative"><canvas id="teacherAssetChart"></canvas></div>
                    </div>

                    <div v-if="stage === 3" class="md:col-span-2 card-retro p-6 bg-white">
                        <h3 class="font-bold text-xl mb-6 text-center">20 å¹´è³‡ç”¢æ¨¡æ“¬ <span class="text-sm font-normal text-gray-400 block">(å‰ä¸‰å vs å¾Œä¸‰å)</span></h3>
                        <div class="h-80 relative"><canvas id="teacherLineChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 3. å­¸ç”Ÿæ“ä½œä»‹é¢ -->
            <div v-if="view === 'student'" class="w-full max-w-md pb-24 space-y-6 font-sans">
                
                <div class="sticky top-4 z-30 card-retro p-3 bg-white flex justify-between items-center shadow-lg">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-retro-blue border-2 border-retro-dark rounded-full flex items-center justify-center text-white font-bold text-lg">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div>
                            <div class="text-[10px] font-bold text-gray-400 uppercase">Current</div>
                            <select v-model="myGroupName" class="bg-transparent font-bold text-retro-dark outline-none cursor-pointer">
                                <option v-for="i in 13" :key="i" :value="`ç¬¬ ${i} çµ„`">ç¬¬ {{ i }} çµ„</option>
                            </select>
                        </div>
                    </div>
                    <select v-model.number="stage" class="text-xs font-bold bg-gray-100 border-2 border-gray-200 rounded-lg px-2 py-1 outline-none cursor-pointer">
                        <option :value="1">Step 1: é ç®—</option>
                        <option :value="2">Step 2: æŠ•è³‡</option>
                        <option :value="3">Step 3: ç¸½çµ</option>
                    </select>
                </div>

                <!-- Stage 1 -->
                <div v-if="stage === 1" class="card-retro p-6 space-y-6 bg-white">
                    <button @click="inflationTriggered = !inflationTriggered" 
                        class="w-full py-3 rounded-xl text-sm font-bold transition border-2 border-dashed border-retro-dark flex items-center justify-center"
                        :class="inflationTriggered ? 'bg-retro-red text-white' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'">
                        <i class="fa-solid fa-fire mr-2"></i> 
                        {{ inflationTriggered ? 'é€šè†¨æ¨¡å¼ï¼šå·²é–‹å•Ÿ (+10%)' : 'é»æ­¤é–‹å•Ÿé€šè†¨' }}
                    </button>

                    <div class="flex justify-between items-end border-b-2 border-gray-100 pb-4">
                        <div>
                            <h2 class="text-xl font-bold text-retro-dark">é ç®—è¦åŠƒ</h2>
                            <p class="text-xs text-gray-400 font-bold">Budgeting</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-400 font-bold">çµé¤˜</div>
                            <div class="text-2xl font-mono font-bold" :class="myBalance < 0 ? 'text-retro-red' : 'text-retro-green'">
                                {{ formatMoney(myBalance) }}
                            </div>
                        </div>
                    </div>

                    <div class="h-40 relative flex justify-center">
                        <canvas id="studentPieChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none mt-4">
                             <span class="font-bold text-sm" :class="myBalance < 0 ? 'text-retro-red' : 'text-gray-400'">{{ myBalance < 0 ? 'é€æ”¯' : 'å‰©é¤˜' }}</span>
                             <span class="font-mono font-bold text-lg text-retro-dark">{{ formatMoney(Math.abs(myBalance)) }}</span>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div v-for="(val, key) in myBudget" :key="key">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-bold text-retro-dark flex items-center">
                                    <i :class="getIcon(key)" class="mr-2 w-6 text-center text-gray-400"></i> {{ translate(key) }}
                                </span>
                                <span class="font-mono font-bold text-gray-500">{{ formatMoney(calculateExpenseItem(val)) }}</span>
                            </div>
                            <input type="range" min="0" max="10000" step="500" v-model.number="myBudget[key]" @input="updateStudentChart" class="w-full h-2 rounded-lg" :class="getColorClass(key)">
                        </div>
                    </div>
                </div>

                <!-- Stage 2 -->
                <div v-if="stage === 2" class="card-retro p-6 space-y-6 bg-white">
                    <div class="flex justify-between items-end border-b-2 border-gray-100 pb-4">
                        <div>
                            <h2 class="text-xl font-bold text-retro-dark">æŠ•è³‡é…ç½®</h2>
                            <p class="text-xs text-gray-400 font-bold">Investment</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-400 font-bold">å¾…åˆ†é…</div>
                            <div class="text-xl font-mono font-bold" :class="investmentRemaining !== 0 ? 'text-retro-red' : 'text-gray-400'">
                                {{ formatMoney(investmentRemaining) }}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button @click="myRiskProfile = 'conservative'" class="btn-retro py-2 rounded-lg font-bold text-sm"
                            :class="myRiskProfile === 'conservative' ? 'bg-retro-green text-white' : 'bg-white text-gray-400 border-gray-300 shadow-none'">
                            ç©©å¥å‹ (ç¶ )
                        </button>
                        <button @click="myRiskProfile = 'aggressive'" class="btn-retro py-2 rounded-lg font-bold text-sm"
                            :class="myRiskProfile === 'aggressive' ? 'bg-retro-red text-white' : 'bg-white text-gray-400 border-gray-300 shadow-none'">
                            ç©æ¥µå‹ (ç´…)
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div v-for="(val, key) in myInvestment" :key="key">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-bold text-retro-dark">{{ translate(key) }}</span>
                                <span class="font-mono font-bold text-gray-500">{{ formatMoney(val) }}</span>
                            </div>
                            <input type="range" min="0" max="100000" step="5000" v-model.number="myInvestment[key]" class="w-full h-2 rounded-lg accent-slate-600">
                        </div>
                    </div>
                    
                    <!-- æ‰‹å‹•äº‹ä»¶ -->
                    <div class="pt-6 border-t-2 border-gray-100">
                        <h3 class="font-bold text-retro-dark mb-3 flex items-center">
                            <i class="fa-solid fa-envelope-open-text mr-2 text-retro-blue"></i> å‘½é‹å¡ (è·Ÿéš¨è€å¸«é¸æ“‡)
                        </h3>
                        <select v-model="selectedFateCardIndex" class="w-full p-3 border-2 border-retro-dark rounded-xl bg-white mb-3 font-bold shadow-retro-sm focus:outline-none">
                            <option :value="-1">-- é¸æ“‡å¡ç‰Œ --</option>
                            <option v-for="(card, idx) in FATE_CARDS" :key="idx" :value="idx">{{ card.title }}</option>
                        </select>
                        <button @click="applyStudentFateCard" :disabled="selectedFateCardIndex === -1" class="w-full py-3 btn-retro bg-retro-blue text-white rounded-xl font-bold disabled:bg-gray-200 disabled:text-gray-400 disabled:border-gray-300 disabled:shadow-none">
                            å¥—ç”¨æ•ˆæœ
                        </button>
                        
                        <div v-if="myTotalAssets !== INITIAL_CAPITAL" class="mt-6 p-4 bg-retro-yellow border-2 border-retro-dark rounded-xl text-center shadow-retro-sm">
                            <p class="text-xs font-bold opacity-60 uppercase tracking-wider">Current Assets</p>
                            <p class="text-3xl font-mono font-bold text-retro-dark">{{ formatMoney(Math.round(myTotalAssets)) }}</p>
                        </div>
                    </div>
                </div>

                <!-- Stage 3 -->
                <div v-if="stage === 3" class="card-retro p-8 text-center bg-white relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-4 bg-retro-yellow border-b-2 border-retro-dark"></div>
                    <i class="fa-solid fa-trophy text-6xl text-retro-yellow drop-shadow-md mb-4 mt-4"></i>
                    <h2 class="text-2xl font-bold mb-2 font-display">GAME OVER!</h2>
                    <div class="py-4 border-y-2 border-dashed border-gray-200 my-4">
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">Final Score</p>
                        <p class="text-4xl font-mono font-bold text-retro-blue mt-2">{{ formatMoney(Math.round(myTotalAssets)) }}</p>
                    </div>
                    <p class="text-gray-400 text-xs font-bold">è«‹å›å ±åˆ†æ•¸çµ¦è€å¸«</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;

        const INCOME = 20000;
        const INITIAL_CAPITAL = 100000;
        
        const FATE_CARDS = [
            { title: "è‚¡å¸‚å¤§æ¼²", effect: { stocks: 1.25, etf: 1.10, savings: 1.005, entrepreneurship: 1.05 } },
            { title: "é‡‘èæµ·å˜¯", effect: { stocks: 0.70, etf: 0.90, savings: 1.00, entrepreneurship: 0.80 } },
            { title: "ETF ç©©å¥æˆé•·", effect: { stocks: 1.05, etf: 1.15, savings: 1.005, entrepreneurship: 1.0 } },
            { title: "å…¨çƒé€šè†¨å‡æº«", effect: { stocks: 0.95, etf: 0.98, savings: 1.00, entrepreneurship: 0.90 } },
            { title: "å‰µæ¥­ç¨è§’ç¸", effect: { stocks: 1.0, etf: 1.05, savings: 1.005, entrepreneurship: 2.5 } },
            { title: "ç§‘æŠ€æ³¡æ²«", effect: { stocks: 0.85, etf: 0.95, savings: 1.00, entrepreneurship: 0.5 } },
        ];

        createApp({
            setup() {
                const view = ref('welcome');
                const stage = ref(1);
                const inflationTriggered = ref(false);
                const drawnCardIndices = ref([]); 
                
                const myGroupName = ref('ç¬¬ 1 çµ„');
                const myBudget = ref({ food: 6000, transport: 3000, entertainment: 2000, education: 4000, family: 5000 });
                const myInvestment = ref({ savings: 25000, etf: 25000, stocks: 25000, entrepreneurship: 25000 });
                const myRiskProfile = ref('conservative');
                const myTotalAssets = ref(INITIAL_CAPITAL);
                const selectedFateCardIndex = ref(-1);

                const simulatedGroups = ref([]);
                const lastDrawnCard = ref(null);

                const initSimData = () => {
                    simulatedGroups.value = Array.from({ length: 13 }, (_, i) => ({
                        id: i + 1,
                        name: `ç¬¬ ${i + 1} çµ„`,
                        investment: { savings: 25000, etf: 25000, stocks: 25000, entrepreneurship: 25000 },
                        totalAssets: 100000,
                        riskProfile: Math.random() > 0.5 ? 'aggressive' : 'conservative'
                    }));
                };
                initSimData();

                const hardReset = () => {
                    if(confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰è¨­å®šä¸¦é‡ç½®ï¼Ÿ")) {
                        localStorage.clear();
                        location.reload();
                    }
                };

                const calculateExpenseItem = (val) => inflationTriggered.value ? val * 1.1 : val;
                const calculateTotalExpense = () => Object.values(myBudget.value).reduce((a, b) => a + b, 0) * (inflationTriggered.value ? 1.1 : 1);
                const myBalance = computed(() => INCOME - calculateTotalExpense());
                const investmentRemaining = computed(() => INITIAL_CAPITAL - Object.values(myInvestment.value).reduce((a, b) => a + b, 0));
                const isCardDeckEmpty = computed(() => drawnCardIndices.value.length >= FATE_CARDS.length);

                const formatMoney = (val) => new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 }).format(val) + ' THB';
                const translate = (key) => ({ food: 'é£Ÿç‰©', transport: 'äº¤é€š', entertainment: 'å¨›æ¨‚', education: 'å­¸ç¿’', family: 'å®¶åº­', savings: 'å®šå­˜', etf: 'ETF', stocks: 'è‚¡ç¥¨', entrepreneurship: 'å‰µæ¥­' }[key] || key);
                const getIcon = (key) => `fa-solid ${{ food: 'fa-bowl-food', transport: 'fa-bus', entertainment: 'fa-gamepad', education: 'fa-book', family: 'fa-house' }[key] || 'fa-coins'}`;
                const getColorClass = (key) => `accent-${{food:'10B981', transport:'3B82F6', entertainment:'F59E0B', education:'8B5CF6', family:'EF4444'}[key]}`;

                const applyStudentFateCard = () => {
                    if(selectedFateCardIndex.value === -1) return;
                    const card = FATE_CARDS[selectedFateCardIndex.value];
                    
                    const inv = myInvestment.value;
                    const newInv = {
                        savings: inv.savings * card.effect.savings,
                        etf: inv.etf * card.effect.etf,
                        stocks: inv.stocks * card.effect.stocks,
                        entrepreneurship: inv.entrepreneurship * card.effect.entrepreneurship
                    };
                    myInvestment.value = newInv; 
                    myTotalAssets.value = Object.values(newInv).reduce((a, b) => a + b, 0);
                    
                    alert(`å·²å¥—ç”¨ï¼š${card.title}\nè³‡ç”¢æ›´æ–°ï¼`);
                    selectedFateCardIndex.value = -1;
                };

                const setStage = (s) => {
                    stage.value = s;
                    nextTick(() => setTimeout(updateCharts, 300));
                };

                const drawFateCard = () => {
                    const availableIndices = FATE_CARDS.map((_, i) => i).filter(i => !drawnCardIndices.value.includes(i));
                    
                    if (availableIndices.length === 0) {
                         alert('å¡ç‰Œå·²ç”¨ç›¡');
                         return;
                    }

                    const randomIndex = Math.floor(Math.random() * availableIndices.length);
                    const cardIndex = availableIndices[randomIndex];
                    const card = FATE_CARDS[cardIndex];
                    
                    drawnCardIndices.value.push(cardIndex);
                    lastDrawnCard.value = card.title;
                    
                    simulatedGroups.value.forEach(g => {
                        const inv = g.investment;
                        g.investment = {
                            savings: inv.savings * card.effect.savings,
                            etf: inv.etf * card.effect.etf,
                            stocks: inv.stocks * card.effect.stocks,
                            entrepreneurship: inv.entrepreneurship * card.effect.entrepreneurship
                        };
                        g.totalAssets = Object.values(g.investment).reduce((a,b) => a+b, 0);
                    });
                    nextTick(updateCharts);
                };

                let studentChartInstance = null;
                const updateStudentChart = () => {
                    const ctx = document.getElementById('studentPieChart');
                    if (!ctx) return;
                    
                    const dataValues = Object.values(myBudget.value);
                    const bgColors = ['#FFD166', '#118AB2', '#EF476F', '#06D6A0', '#073B4C'];

                    if (studentChartInstance) {
                        studentChartInstance.data.datasets[0].data = dataValues;
                        studentChartInstance.update();
                    } else {
                        studentChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: { labels: Object.keys(myBudget.value).map(translate), datasets: [{ data: dataValues, backgroundColor: bgColors, borderWidth: 2, borderColor: '#073B4C' }] },
                            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
                        });
                    }
                };

                let teacherAssetChartInstance = null;
                let teacherLineChartInstance = null;
                const updateCharts = () => {
                    if (view.value !== 'teacher') return;

                    if (stage.value === 2) {
                        const ctx = document.getElementById('teacherAssetChart');
                        if (ctx) {
                            if (teacherAssetChartInstance) teacherAssetChartInstance.destroy();
                            teacherAssetChartInstance = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: simulatedGroups.value.map(g => g.name),
                                    datasets: [{ label: 'ç¸½è³‡ç”¢', data: simulatedGroups.value.map(g => g.totalAssets), backgroundColor: '#118AB2', borderWidth: 2, borderColor: '#073B4C' }]
                                },
                                options: { responsive: true, maintainAspectRatio: false }
                            });
                        }
                    }
                    
                    if (stage.value === 3) {
                        const ctx = document.getElementById('teacherLineChart');
                        if (ctx) {
                            if (teacherLineChartInstance) teacherLineChartInstance.destroy();
                            
                             const sorted = [...simulatedGroups.value].sort((a, b) => b.totalAssets - a.totalAssets);
                             const top3Ids = sorted.slice(0, 3).map(g => g.id);
                             const bottom3Ids = sorted.slice(-3).map(g => g.id);
                             const targets = sorted.filter(g => top3Ids.includes(g.id) || bottom3Ids.includes(g.id));

                             const years = Array.from({length: 21}, (_, i) => `${i}å¹´`);
                             const datasets = targets.map(g => {
                                const total = g.totalAssets;
                                const inv = g.investment;
                                const weightedReturn = (
                                    (inv.savings * 0.02) + 
                                    (inv.etf * 0.06) + 
                                    (inv.stocks * 0.08) + 
                                    (inv.entrepreneurship * 0.12)
                                ) / total;
                                
                                const baseRate = 1 + weightedReturn;
                                
                                const entrepreneurialRatio = inv.entrepreneurship / total;
                                let hasFailed = false;
                                const seed = (g.id * 11) % 100; 
                                if (entrepreneurialRatio > 0.3 && seed < 30) {
                                    hasFailed = true;
                                }
                                
                                let data = [Math.round(total)];
                                let currentAsset = total;
                                
                                for(let y=1; y<=20; y++) {
                                    if (hasFailed && y >= 10) {
                                        currentAsset = (inv.savings + inv.etf + inv.stocks) * Math.pow(0.98, y - 10);
                                        currentAsset = Math.max(currentAsset, total * 0.1);
                                    } else {
                                        currentAsset = g.totalAssets * Math.pow(baseRate, y);
                                    }
                                    data.push(Math.round(currentAsset));
                                }
                                
                                const isTop = top3Ids.includes(g.id);
                                const rank = sorted.findIndex(s => s.id === g.id) + 1;
                                
                                let distinctColor;
                                if (isTop) {
                                    if(rank === 1) distinctColor = '#06D6A0'; 
                                    else if(rank === 2) distinctColor = '#118AB2';
                                    else distinctColor = '#FFD166';
                                } else {
                                    const bottomIndex = bottom3Ids.indexOf(g.id); 
                                    if(bottomIndex === 2) distinctColor = '#073B4C';
                                    else if(bottomIndex === 1) distinctColor = '#EF476F';
                                    else distinctColor = '#FF8FAB';
                                }
                                
                                const labelSuffix = hasFailed ? " (é¢¨éšªçˆ†ç™¼)" : ` (å¹´åŒ– ${(weightedReturn * 100).toFixed(1)}%)`;

                                return {
                                    label: `No.${rank} ${g.name}` + labelSuffix,
                                    data: data,
                                    borderColor: distinctColor,
                                    backgroundColor: distinctColor,
                                    borderWidth: isTop ? 4 : 2,
                                    borderDash: hasFailed ? [10, 5] : [],
                                    fill: false,
                                    tension: 0.4
                                };
                             });

                            teacherLineChartInstance = new Chart(ctx, {
                                type: 'line',
                                data: { labels: years, datasets: datasets },
                                options: { responsive: true, maintainAspectRatio: false }
                            });
                        }
                    }
                };

                watch(view, (newVal) => {
                    if(newVal === 'student' && stage.value === 1) nextTick(updateStudentChart);
                    if(newVal === 'teacher') nextTick(() => setTimeout(updateCharts, 300));
                });
                watch(myBudget, updateStudentChart, { deep: true });
                watch(stage, () => {
                    if(view.value === 'student' && stage.value === 1) nextTick(updateStudentChart);
                    if(view.value === 'teacher') nextTick(() => setTimeout(updateCharts, 300));
                });

                return {
                    view, stage, inflationTriggered,
                    myGroupName, myBudget, myInvestment, myRiskProfile, myTotalAssets, selectedFateCardIndex,
                    simulatedGroups, lastDrawnCard, drawnCardIndices, isCardDeckEmpty,
                    hardReset, formatMoney, translate, getIcon, getColorClass,
                    calculateExpenseItem, calculateTotalExpense, myBalance, investmentRemaining,
                    applyStudentFateCard, updateStudentChart,
                    setStage, drawFateCard,
                    INITIAL_CAPITAL, INCOME, FATE_CARDS
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
