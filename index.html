<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一新中學理財 (單機版)</title>
    
    <!-- ★★★ 設定自訂 Icon ★★★ -->
    <!-- 已修改為 icon.png -->
    <link rel="icon" type="image/png" href="icon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Noto Sans TC', 'Segoe UI', sans-serif; 
            background-color: #FFFBEB; /* 暖黃色背景 */
            background-image: radial-gradient(#FEF3C7 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .transition-all { transition: all 0.3s ease; }
        
        /* 更有趣的卡片懸浮效果 */
        .card-hover { transition: transform 0.2s, box-shadow 0.2s; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }

        /* 滑桿樣式優化 - 增加點擊區域 */
        input[type=range] { 
            -webkit-appearance: none; background: transparent; cursor: pointer; position: relative; z-index: 20; height: 30px; margin: 10px 0;
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%; background: #ffffff; border: 4px solid currentColor; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; height: 8px; cursor: pointer; background: #e5e7eb; border-radius: 999px; 
        }
        
        /* 定義滑桿顏色 */
        .accent-10B981 { color: #10B981; }
        .accent-3B82F6 { color: #3B82F6; }
        .accent-F59E0B { color: #F59E0B; }
        .accent-EF4444 { color: #EF4444; }
        .accent-8B5CF6 { color: #8B5CF6; }
        .accent-475569 { color: #475569; }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" v-cloak class="min-h-screen flex flex-col">
        
        <!-- 導航列 (加入快速切換按鈕) -->
        <nav class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-slate-100">
            <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-2">
                <div class="flex items-center space-x-2 font-bold text-xl text-emerald-600 tracking-wide cursor-pointer" @click="view = 'welcome'">
                    <i class="fa-solid fa-leaf text-emerald-500"></i>
                    <span>一新中學理財 <span class="text-slate-400 text-sm font-normal ml-1 hidden sm:inline">| 單機版</span></span>
                </div>
                
                <!-- 快速切換視角按鈕 -->
                <div class="flex space-x-2 text-sm font-medium" v-if="view !== 'welcome'">
                    <button @click="view = 'student'" 
                        :class="view === 'student' ? 'bg-amber-100 text-amber-700' : 'text-slate-500 hover:bg-slate-100'"
                        class="px-3 py-1.5 rounded-lg transition flex items-center">
                        <i class="fa-solid fa-user mr-1"></i> 我的資產
                    </button>
                    <button @click="view = 'teacher'" 
                        :class="view === 'teacher' ? 'bg-emerald-100 text-emerald-700' : 'text-slate-500 hover:bg-slate-100'"
                        class="px-3 py-1.5 rounded-lg transition flex items-center">
                        <i class="fa-solid fa-chart-line mr-1"></i> 市場模擬 (老師)
                    </button>
                    <div class="w-px h-6 bg-slate-200 mx-1"></div>
                    <button @click="view = 'welcome'" class="px-3 py-1.5 rounded-lg text-slate-500 hover:bg-slate-100 transition">
                        <i class="fa-solid fa-house"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- 主要內容區 -->
        <main class="container mx-auto p-4 md:p-8 flex-grow">
            
            <!-- 1. 歡迎畫面 -->
            <div v-if="view === 'welcome'" class="flex flex-col items-center justify-center h-[80vh] space-y-8 animate-fade-in">
                <div class="text-center space-y-4">
                    <span class="inline-block px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold tracking-wider">FINANCIAL LITERACY WORKSHOP</span>
                    <h1 class="text-4xl md:text-6xl font-bold text-slate-800 tracking-tight">理財體驗課 <span class="text-emerald-500">Offline</span></h1>
                    <p class="text-slate-500">單機練習模式：可自由切換「個人練習」與「市場模擬」視角。</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-3xl mt-8">
                    <button @click="view = 'student'" class="group relative p-8 bg-white rounded-3xl shadow-lg card-hover border-2 border-transparent hover:border-amber-200 text-left overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-amber-50 rounded-bl-full -mr-8 -mt-8 z-0 group-hover:scale-110 transition"></div>
                        <div class="relative z-10">
                            <div class="w-12 h-12 bg-amber-100 rounded-2xl flex items-center justify-center text-amber-600 mb-4 text-2xl">
                                <i class="fa-solid fa-mobile-screen"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-1 text-slate-800">進入個人練習</h3>
                            <p class="text-slate-400 text-sm">Student Mode</p>
                            <p class="text-slate-500 mt-4 text-sm">操作你自己的預算與投資，計算最終資產。</p>
                        </div>
                    </button>

                    <button @click="view = 'teacher'" class="group relative p-8 bg-white rounded-3xl shadow-lg card-hover border-2 border-transparent hover:border-emerald-200 text-left overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-50 rounded-bl-full -mr-8 -mt-8 z-0 group-hover:scale-110 transition"></div>
                        <div class="relative z-10">
                            <div class="w-12 h-12 bg-emerald-100 rounded-2xl flex items-center justify-center text-emerald-600 mb-4 text-2xl">
                                <i class="fa-solid fa-chart-simple"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-1 text-slate-800">查看市場模擬</h3>
                            <p class="text-slate-400 text-sm">Simulation / Teacher View</p>
                            <p class="text-slate-500 mt-4 text-sm">觀看 13 組模擬數據的市場變化與長期複利圖表。</p>
                        </div>
                    </button>
                </div>
                
                <div class="mt-12">
                    <button @click="hardReset" class="text-xs text-slate-400 hover:text-red-500 border-b border-transparent hover:border-red-500 transition">
                        <i class="fa-solid fa-rotate-right mr-1"></i> 清除本機暫存資料
                    </button>
                </div>
            </div>

            <!-- 2. 老師演示模式 (模擬數據) -->
            <div v-if="view === 'teacher'" class="space-y-6">
                <!-- 頂部控制列 -->
                <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-emerald-500 flex flex-wrap gap-4 justify-between items-center sticky top-20 z-40">
                    <div class="flex items-center space-x-3">
                        <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600"><i class="fa-solid fa-chart-pie"></i></div>
                        <div>
                            <h2 class="text-lg font-bold text-slate-800">市場模擬看板 (老師視角)</h2>
                            <p class="text-xs text-slate-400">此處顯示的是系統生成的 13 組模擬數據</p>
                        </div>
                    </div>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button v-for="s in [1, 2, 3]" :key="s" @click="setStage(s)" 
                            :class="stage === s ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'"
                            class="px-4 py-2 rounded-lg text-sm font-bold transition">
                            {{ ['1. 預算', '2. 投資', '3. 總結'][s-1] }}
                        </button>
                    </div>
                </div>

                <!-- 老師控制區 -->
                <div class="flex flex-wrap gap-3">
                    <button v-if="stage === 1" @click="inflationTriggered = !inflationTriggered" 
                        :class="inflationTriggered ? 'bg-rose-500 text-white ring-4 ring-rose-200' : 'bg-white text-rose-500 border-2 border-rose-100 hover:border-rose-500'"
                        class="px-6 py-3 rounded-xl font-bold shadow-sm transition flex items-center">
                        <i class="fa-solid fa-triangle-exclamation mr-2"></i> 
                        {{ inflationTriggered ? '演示：通膨已觸發' : '演示：觸發通膨' }}
                    </button>

                    <button v-if="stage === 2" @click="drawFateCard" 
                        class="px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 transition flex items-center bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-105 active:scale-95">
                        <i class="fa-solid fa-dice mr-2"></i> 抽取命運卡 (模擬市場)
                    </button>
                </div>

                <!-- 老師圖表區 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div v-if="stage === 2" class="md:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-bold text-xl text-slate-800"><i class="fa-solid fa-chart-simple mr-2 text-blue-500"></i> 資產模擬排行</h3>
                            <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded">範例數據</span>
                        </div>
                        <div v-if="lastDrawnCard" class="mb-6 p-4 bg-indigo-50 border border-indigo-100 text-indigo-700 rounded-xl text-center animate-bounce">
                            <span class="block text-xs font-bold uppercase tracking-wider opacity-70 mb-1">Market Event</span>
                            <strong class="text-lg">{{ lastDrawnCard }}</strong>
                        </div>
                        <div class="h-64 relative"><canvas id="teacherAssetChart"></canvas></div>
                    </div>

                    <div v-if="stage === 3" class="md:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-xl text-slate-800 mb-6 text-center">20 年資產模擬 <span class="text-sm font-normal text-slate-400">(前三名 vs 後三名)</span></h3>
                        <div class="h-80 relative"><canvas id="teacherLineChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 3. 學生操作介面 (本地計算) -->
            <div v-if="view === 'student'" class="max-w-md mx-auto pb-24 space-y-6">
                
                <div class="sticky top-4 z-30 bg-white/95 backdrop-blur p-4 rounded-2xl shadow-lg border border-slate-100 flex justify-between items-center">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center text-amber-600 mr-3 font-bold">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400">Current Group</div>
                            <select v-model="myGroupName" class="bg-transparent font-bold text-slate-800 outline-none cursor-pointer">
                                <option v-for="i in 13" :key="i" :value="`第 ${i} 組`">第 {{ i }} 組</option>
                            </select>
                        </div>
                    </div>
                    <!-- 學生手動切換階段 -->
                    <select v-model.number="stage" class="text-xs bg-slate-800 text-white rounded-lg px-2 py-1 border-none cursor-pointer">
                        <option :value="1">Step 1: 預算</option>
                        <option :value="2">Step 2: 投資</option>
                        <option :value="3">Step 3: 總結</option>
                    </select>
                </div>

                <!-- Stage 1: 預算 -->
                <div v-if="stage === 1" class="bg-white rounded-3xl shadow-sm p-6 space-y-6 border border-slate-100">
                    <button @click="inflationTriggered = !inflationTriggered" 
                        class="w-full py-3 rounded-xl text-sm font-bold transition border-2 border-dashed flex items-center justify-center"
                        :class="inflationTriggered ? 'bg-rose-50 text-rose-600 border-rose-200' : 'bg-slate-50 text-slate-400 border-slate-200 hover:bg-slate-100'">
                        <i class="fa-solid fa-triangle-exclamation mr-2"></i> 
                        {{ inflationTriggered ? '通膨模式：已開啟 (+10%)' : '點此開啟通膨 (跟隨老師)' }}
                    </button>

                    <div class="flex justify-between items-end border-b border-slate-100 pb-4">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">預算規劃</h2>
                            <p class="text-xs text-slate-400">Monthly Budget</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-500">結餘</div>
                            <div class="text-xl font-mono font-bold" :class="myBalance < 0 ? 'text-rose-500' : 'text-emerald-500'">
                                {{ formatMoney(myBalance) }}
                            </div>
                        </div>
                    </div>

                    <!-- 圓餅圖 -->
                    <div class="h-48 relative flex justify-center">
                        <canvas id="studentPieChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none mt-4">
                             <span class="font-bold text-sm" :class="myBalance < 0 ? 'text-rose-500' : 'text-slate-400'">{{ myBalance < 0 ? '透支' : '剩餘' }}</span>
                             <span class="font-mono font-bold text-lg text-slate-600">{{ formatMoney(Math.abs(myBalance)) }}</span>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div v-for="(val, key) in myBudget" :key="key">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="font-bold text-slate-600 flex items-center">
                                    <span class="w-6 h-6 rounded-full flex items-center justify-center mr-2 text-white text-xs" :class="`bg-${{food:'emerald-500', transport:'blue-500', entertainment:'amber-500', education:'purple-500', family:'rose-500'}[key]}`">
                                        <i :class="getIcon(key)"></i>
                                    </span>
                                    {{ translate(key) }}
                                </span>
                                <span class="font-mono text-slate-500">{{ formatMoney(calculateExpenseItem(val)) }}</span>
                            </div>
                            <input type="range" min="0" max="10000" step="500" v-model.number="myBudget[key]" @input="updateStudentChart" class="w-full h-2 rounded-lg" :class="getColorClass(key)">
                        </div>
                    </div>
                </div>

                <!-- Stage 2: 投資 -->
                <div v-if="stage === 2" class="bg-white rounded-3xl shadow-sm p-6 space-y-6 border border-slate-100">
                    <div class="flex justify-between items-end border-b border-slate-100 pb-4">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">投資配置</h2>
                            <p class="text-xs text-slate-400">Investment</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-500">剩餘資金 (需為 0)</div>
                            <div class="text-xl font-mono font-bold" :class="investmentRemaining !== 0 ? 'text-rose-500' : 'text-slate-700'">
                                {{ formatMoney(investmentRemaining) }}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button @click="myRiskProfile = 'conservative'" :class="myRiskProfile === 'conservative' ? 'ring-2 ring-emerald-500 bg-emerald-50 text-emerald-700' : 'bg-slate-50 text-slate-400'" class="p-3 rounded-xl border transition text-sm font-bold">
                            <i class="fa-solid fa-shield-halved mr-1"></i> 穩健型
                        </button>
                        <button @click="myRiskProfile = 'aggressive'" :class="myRiskProfile === 'aggressive' ? 'ring-2 ring-rose-500 bg-rose-50 text-rose-700' : 'bg-slate-50 text-slate-400'" class="p-3 rounded-xl border transition text-sm font-bold">
                            <i class="fa-solid fa-rocket mr-1"></i> 積極型
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div v-for="(val, key) in myInvestment" :key="key">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="font-medium text-slate-700">{{ translate(key) }}</span>
                                <span class="font-mono text-slate-500">{{ formatMoney(val) }}</span>
                            </div>
                            <input type="range" min="0" max="100000" step="5000" v-model.number="myInvestment[key]" class="w-full h-2 rounded-lg accent-slate-600">
                        </div>
                    </div>
                    
                    <!-- 手動事件觸發 -->
                    <div class="pt-6 border-t border-slate-100">
                        <h3 class="font-bold text-slate-700 mb-3 flex items-center">
                            <i class="fa-solid fa-envelope-open-text mr-2 text-indigo-500"></i> 命運卡 (跟隨老師選擇)
                        </h3>
                        <select v-model="selectedFateCardIndex" class="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 mb-3 text-slate-700 font-medium">
                            <option :value="-1">-- 請選擇老師抽到的卡 --</option>
                            <option v-for="(card, idx) in FATE_CARDS" :key="idx" :value="idx">{{ card.title }}</option>
                        </select>
                        <button @click="applyStudentFateCard" :disabled="selectedFateCardIndex === -1" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold disabled:bg-slate-200 disabled:text-slate-400 transition">
                            套用效果
                        </button>
                        
                        <div v-if="myTotalAssets !== INITIAL_CAPITAL" class="mt-6 p-4 bg-indigo-50 border border-indigo-100 rounded-2xl text-center">
                            <p class="text-xs text-indigo-400 uppercase font-bold tracking-wider mb-1">Current Assets</p>
                            <p class="text-3xl font-mono font-bold text-indigo-600">{{ formatMoney(Math.round(myTotalAssets)) }}</p>
                        </div>
                    </div>
                </div>

                <!-- Stage 3: 結束 -->
                <div v-if="stage === 3" class="bg-white rounded-3xl shadow-lg p-10 text-center">
                    <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fa-solid fa-trophy text-4xl text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2 text-slate-800">課程結束！</h2>
                    <p class="text-slate-500 text-sm mb-6">Congratulations!</p>
                    <div class="p-6 bg-slate-50 rounded-2xl border border-slate-100">
                        <p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-2">Final Result</p>
                        <p class="text-4xl font-mono font-bold text-slate-800">{{ formatMoney(Math.round(myTotalAssets)) }}</p>
                    </div>
                    <p class="text-slate-400 text-xs mt-6">請舉手回報此數字給老師進行結算。</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;

        const INCOME = 20000;
        const INITIAL_CAPITAL = 100000;
        
        const FATE_CARDS = [
            { title: "股市大漲", effect: { stocks: 1.25, etf: 1.10, savings: 1.005, entrepreneurship: 1.05 } },
            { title: "金融海嘯", effect: { stocks: 0.70, etf: 0.90, savings: 1.00, entrepreneurship: 0.80 } },
            { title: "ETF 穩健成長", effect: { stocks: 1.05, etf: 1.15, savings: 1.005, entrepreneurship: 1.0 } },
            { title: "全球通膨升溫", effect: { stocks: 0.95, etf: 0.98, savings: 1.00, entrepreneurship: 0.90 } },
            { title: "創業獨角獸", effect: { stocks: 1.0, etf: 1.05, savings: 1.005, entrepreneurship: 2.5 } },
            { title: "科技泡沫", effect: { stocks: 0.85, etf: 0.95, savings: 1.00, entrepreneurship: 0.5 } },
        ];

        createApp({
            setup() {
                const view = ref('welcome');
                const stage = ref(1);
                const inflationTriggered = ref(false);
                
                // Student State
                const myGroupName = ref('第 1 組');
                const myBudget = ref({ food: 6000, transport: 3000, entertainment: 2000, education: 4000, family: 5000 });
                const myInvestment = ref({ savings: 25000, etf: 25000, stocks: 25000, entrepreneurship: 25000 });
                const myRiskProfile = ref('conservative');
                const myTotalAssets = ref(INITIAL_CAPITAL);
                const selectedFateCardIndex = ref(-1);

                // Teacher Simulated Data
                const simulatedGroups = ref([]);
                const lastDrawnCard = ref(null);

                // Init Simulation Data for Teacher
                const initSimData = () => {
                    simulatedGroups.value = Array.from({ length: 13 }, (_, i) => ({
                        id: i + 1,
                        name: `第 ${i + 1} 組`,
                        investment: { savings: 25000, etf: 25000, stocks: 25000, entrepreneurship: 25000 },
                        totalAssets: 100000,
                        riskProfile: Math.random() > 0.5 ? 'aggressive' : 'conservative'
                    }));
                };
                initSimData();

                // Clean Reset
                const hardReset = () => {
                    if(confirm("確定清除所有設定並重置？")) {
                        localStorage.clear();
                        location.reload();
                    }
                };

                // Computed
                const calculateExpenseItem = (val) => inflationTriggered.value ? val * 1.1 : val;
                const calculateTotalExpense = () => Object.values(myBudget.value).reduce((a, b) => a + b, 0) * (inflationTriggered.value ? 1.1 : 1);
                const myBalance = computed(() => INCOME - calculateTotalExpense());
                const investmentRemaining = computed(() => INITIAL_CAPITAL - Object.values(myInvestment.value).reduce((a, b) => a + b, 0));

                // Helpers
                const formatMoney = (val) => new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 }).format(val) + ' THB';
                const translate = (key) => ({ food: '食物', transport: '交通', entertainment: '娛樂', education: '學習', family: '家庭', savings: '定存', etf: 'ETF', stocks: '股票', entrepreneurship: '創業' }[key] || key);
                const getIcon = (key) => `fa-solid ${{ food: 'fa-bowl-food', transport: 'fa-bus', entertainment: 'fa-gamepad', education: 'fa-book', family: 'fa-house' }[key] || 'fa-coins'}`;
                const getColorClass = (key) => `accent-${{food:'10B981', transport:'3B82F6', entertainment:'F59E0B', education:'8B5CF6', family:'EF4444'}[key]}`;

                // Student Logic
                const applyStudentFateCard = () => {
                    if(selectedFateCardIndex.value === -1) return;
                    const card = FATE_CARDS[selectedFateCardIndex.value];
                    
                    // Simple calculation for student
                    const inv = myInvestment.value;
                    const newInv = {
                        savings: inv.savings * card.effect.savings,
                        etf: inv.etf * card.effect.etf,
                        stocks: inv.stocks * card.effect.stocks,
                        entrepreneurship: inv.entrepreneurship * card.effect.entrepreneurship
                    };
                    myInvestment.value = newInv; // Update local state
                    myTotalAssets.value = Object.values(newInv).reduce((a, b) => a + b, 0);
                    
                    alert(`已套用：${card.title}\n資產更新！`);
                    selectedFateCardIndex.value = -1;
                };

                // Teacher Logic (Simulated)
                const setStage = (s) => {
                    stage.value = s;
                    nextTick(() => setTimeout(updateCharts, 300));
                };

                const drawFateCard = () => {
                    const card = FATE_CARDS[Math.floor(Math.random() * FATE_CARDS.length)];
                    lastDrawnCard.value = card.title;
                    
                    // Update simulated groups
                    simulatedGroups.value.forEach(g => {
                        const inv = g.investment;
                        g.investment = {
                            savings: inv.savings * card.effect.savings,
                            etf: inv.etf * card.effect.etf,
                            stocks: inv.stocks * card.effect.stocks,
                            entrepreneurship: inv.entrepreneurship * card.effect.entrepreneurship
                        };
                        g.totalAssets = Object.values(g.investment).reduce((a,b) => a+b, 0);
                    });
                    nextTick(updateCharts);
                };

                // Charts
                let studentChartInstance = null;
                const updateStudentChart = () => {
                    const ctx = document.getElementById('studentPieChart');
                    if (!ctx) return;
                    
                    const dataValues = Object.values(myBudget.value);
                    const bgColors = ['#10B981', '#3B82F6', '#F59E0B', '#8B5CF6', '#EF4444'];

                    if (studentChartInstance) {
                        studentChartInstance.data.datasets[0].data = dataValues;
                        studentChartInstance.update();
                    } else {
                        studentChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: { labels: Object.keys(myBudget.value).map(translate), datasets: [{ data: dataValues, backgroundColor: bgColors, borderWidth: 0 }] },
                            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
                        });
                    }
                };

                let teacherAssetChartInstance = null;
                let teacherLineChartInstance = null;
                const updateCharts = () => {
                    if (view.value !== 'teacher') return;

                    if (stage.value === 2) {
                        const ctx = document.getElementById('teacherAssetChart');
                        if (ctx) {
                            if (teacherAssetChartInstance) teacherAssetChartInstance.destroy();
                            teacherAssetChartInstance = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: simulatedGroups.value.map(g => g.name),
                                    datasets: [{ label: '總資產', data: simulatedGroups.value.map(g => g.totalAssets), backgroundColor: '#3B82F6' }]
                                },
                                options: { responsive: true, maintainAspectRatio: false }
                            });
                        }
                    }
                    
                    if (stage.value === 3) {
                        const ctx = document.getElementById('teacherLineChart');
                        if (ctx) {
                            if (teacherLineChartInstance) teacherLineChartInstance.destroy();
                            // Generate simulation data... (Same logic as online version but fully local)
                             const sorted = [...simulatedGroups.value].sort((a, b) => b.totalAssets - a.totalAssets);
                             const targets = sorted.slice(0, 3).concat(sorted.slice(-3));
                             const years = Array.from({length: 21}, (_, i) => `${i}年`);
                             const datasets = targets.map(g => {
                                const total = g.totalAssets;
                                const inv = g.investment;
                                const rate = 1 + ((inv.savings*0.02 + inv.etf*0.06 + inv.stocks*0.08 + inv.entrepreneurship*0.12) / total);
                                let data = [];
                                let current = total;
                                for(let y=0; y<=20; y++) {
                                    data.push(Math.round(current));
                                    current *= rate;
                                }
                                return {
                                    label: g.name, data: data, borderColor: '#10B981', fill: false
                                };
                             });

                            teacherLineChartInstance = new Chart(ctx, {
                                type: 'line',
                                data: { labels: years, datasets: datasets },
                                options: { responsive: true, maintainAspectRatio: false }
                            });
                        }
                    }
                };

                watch(view, (newVal) => {
                    if(newVal === 'student' && stage.value === 1) nextTick(updateStudentChart);
                    if(newVal === 'teacher') nextTick(() => setTimeout(updateCharts, 300));
                });
                watch(myBudget, updateStudentChart, { deep: true });
                watch(stage, () => {
                    if(view.value === 'student' && stage.value === 1) nextTick(updateStudentChart);
                    if(view.value === 'teacher') nextTick(() => setTimeout(updateCharts, 300));
                });

                return {
                    view, stage, inflationTriggered,
                    myGroupName, myBudget, myInvestment, myRiskProfile, myTotalAssets, selectedFateCardIndex,
                    simulatedGroups, lastDrawnCard,
                    hardReset, formatMoney, translate, getIcon, getColorClass,
                    calculateExpenseItem, calculateTotalExpense, myBalance, investmentRemaining,
                    applyStudentFateCard, updateStudentChart,
                    setStage, drawFateCard,
                    INITIAL_CAPITAL, INCOME, FATE_CARDS
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
